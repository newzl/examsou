layui.config({ base: "/scripts/modules/" }).use(["layer", "timer"], function () { var f = layui.layer, a = layui.timer, c = null, g = true, b = "COURSETIME", h = $("#timer"), k = $("#maincontent"), j = { winHeig: function () { $(".cou-heig").css("height", $(window).height() - 104); k.css("height", $(window).height() - 144) }, initSet: function () { var p = "COURSESETTINGCOOKIE", l = $.cookie(p), n = {}; if (l !== undefined && l !== null) { n = $.parseJSON(l) } else { n = { skin: 0, font: 0 } } o(); $(".setting").off().on("click", function () { var v = "layui-btn-primary", u = n.skin == 0 ? "" : v, t = n.skin == 1 ? "" : v, r = n.font == 0 ? "" : v, q = n.font == 1 ? "" : v, w = n.font == 2 ? "" : v; var s = '<table><tr><td>皮肤：</td><td class="settskin">'; s += '<button value="0" class="layui-btn layui-btn-xs ' + u + '">正常</button>'; s += '<button value="1" class="layui-btn layui-btn-xs ' + t + '">夜间</button>'; s += '</td></tr><tr><td>字体：</td><td style="padding-top:5px;" class="settfont">'; s += '<button value="0" class="layui-btn layui-btn-xs ' + r + '">小</button>'; s += '<button value="1" class="layui-btn layui-btn-xs ' + q + '">中</button>'; s += '<button value="2" class="layui-btn layui-btn-xs ' + w + '">大</button>'; s += "</td></tr></table>"; f.tips(s, ".setting", { time: 3000, tips: [1, "#999"], success: function () { $(".settskin .layui-btn-primary").off().on("click", function () { n["skin"] = parseInt($(this).val()); m() }); $(".settfont .layui-btn-primary").off().on("click", function () { n["font"] = parseInt($(this).val()); m() }) } }) }); function m() { $.cookie(p, JSON.stringify(n), { expires: 360, path: "/" }); o(); f.closeAll() } function o() { var q = $("#maincontent"); if (n.skin === 1) { $("body").addClass("black") } else { $("body").removeClass("black") } switch (n.font) { case 0: q.removeClass("font18 font20").addClass("font16"); break; case 1: q.removeClass("font16 font20").addClass("font18"); break; case 2: q.removeClass("font16 font18").addClass("font20"); break } } }, tips: function () { f.tips("请点击“退出学习”按钮暂停或结束学习，否则不计学时哟！", "#quit", { time: 10000, tips: [4, "#2F4056"] }); $(".layui-layer-tips").click(function () { f.closeAll("tips") }) }, keJian: function () { e(function (l) { i.getlist(l.miid, l.kjid, function (n) { var m = $.cookie(b), o = null; if (m !== undefined && m !== null) { o = a.minuteAgo(m) > a.minuteAgo(n.timer) ? m : n.timer } else { o = n.timer } c = a.counts(h, o); $("#title").text(n.title); $("head title").text("正在学习-" + n.title); k.load("/upload/171212/105123.html", function () { k.scrollTop(n.position) }) }) }) } }, d = { openkj: function () { var m = $(".cou-shade"), n = $(".cou-chapter"), l = $(".chapter-tool"); l.off().on("click", function () { if (n.width() <= 0) { m.show(); n.children("ul").show(); n.animate({ width: 200 }, 100) } else { m.hide(); n.children("ul").hide(); n.animate({ width: 0 }, 100) } }); m.off().on("click", function () { $(this).hide(); n.animate({ width: 0 }, 100) }) }, prev_next: function () { var l = this, n = $(".cou-prev"), m = $(".cou-next"); n.off().on("click", function () { var p = $(".inthis"), o = p.parent("li").prev(); if (o.length > 0) { i.save(function () { l.hideChapter(); window.location.hash = "#!kj=" + o.children("a").data("kjid"); j.keJian() }) } else { f.msg("已经是第一章了") } }); m.off().on("click", function () { var p = $(".inthis"), o = p.parent("li").next(); if (o.length > 0) { i.save(function () { l.hideChapter(); window.location.hash = "#!kj=" + o.children("a").data("kjid"); j.keJian() }) } else { f.msg("已经是最后一章了") } }) }, quit: function () { $("#quit").off().on("click", function () { i.save(function () { g = false; window.location.replace("/myitem") }) }) }, browser: function () { window.onbeforeunload = function (l) { if (g) { $.cookie(b, h.text(), { expires: 5, path: "/" }) } } }, chapter: function (m) { var l = this; m.off().on("click", "a", function () { var n = $(this); if (!n.hasClass("inthis")) { i.save(function () { l.hideChapter(); window.location.hash = "#!kj=" + n.data("kjid"); j.keJian() }) } }) }, hideChapter: function () { var l = $(".cou-shade"), m = $(".cou-chapter"); l.hide(); m.children("ul").hide(); m.animate({ width: 0 }, 100) }, delCookie: function () { $.cookie(b, null, { path: "/", expires: -1 }) } }, i = { save: function (l) { e(function (n) { var m = h.text(); if (m.length > 0) { $.ajax({ url: "/api/record", type: "POST", dataType: "json", cache: false, data: { miid: n.miid, kjid: n.kjid, minut: a.minuteAgo(m), timer: m, position: k.scrollTop() }, beforeSend: function () { f.load(2) }, success: function () { window.clearInterval(c); d.delCookie(); h.text(""); l() }, complete: function () { f.closeAll("loading") }, error: function (o) { alert("ajaxError:" + o.responseText) } }) } else { f.msg("时间还未加载完成……") } }) }, getlist: function (l, m, n) { $.ajax({ url: "/api/record", type: "GET", dataType: "json", cache: false, data: { miid: l }, beforeSend: function () { f.load(2) }, success: function (p) { var q = $("#chapter"), o = {}; q.empty(); $.each(p, function (t, u) { var r = $("<li/>", { "class": "layui-elip" }), s = $("<a/>", { "data-kjid": u.id, text: u.title, title: u.title }); if (u.id === m) { s.addClass("inthis"); o = u } q.append(r.append(s)) }); d.chapter(q); n(o) }, complete: function () { f.closeAll("loading") }, error: function (o) { alert("ajaxError:" + o.responseText) } }) } }; $(function () { j.winHeig(); j.initSet(); j.keJian(); j.tips(); d.openkj(); d.prev_next(); d.quit(); d.browser() }); function e(l) { var m = parseInt(location.hash.replace("#!kj=", "")); if ($.isNumeric(m) && m > 0) { l({ miid: parseInt($("#miid").val()), kjid: m }) } else { g = false; window.location.replace("/myitem") } } });