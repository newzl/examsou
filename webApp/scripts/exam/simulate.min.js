$.getScript("/content/icheck/icheck.min.js", function () { $.getScript("/scripts/exam/downCount.js", function () { layui.config({ base: "/scripts/modules/" }).use(["layer", "util", "element", "laytpl", "exameven"], function () { var r = layui.layer, a = layui.util, e = layui.element, d = layui.laytpl, f = layui.exameven, b, c, k, g, q, p, o, m, i = $(".countdown"), l = { param: function () { b = new Array(), c = new Array(), k = new Array(), g = new Array(), q = new Array(), p = new Array(), o = false, m = false } }, h = { marking: function () { i.downCount(0, function (x) { var C = new Array(), J = new Array(), A = new Array(), G = 0, H = 0, L = 0, w = 0, s = 0, E = 0; var z = $("#subView"); z.find("input").iCheck("disable"); if (b.length > 0) { z.find(".dan").each(function (N) { var M = $(this).find(".checked input"); if (M.length > 0) { C.push(M.val()); if (g[N] === M.val()) { G++ } else { w++; if (!m) { $("#" + $(this).attr("id").replace(/t/gm, "n")).addClass("cd"); $(this).append('<div class="item" style="color: red;">答案：' + g[N] + "</div>") } } } else { C.push("") } }) } if (c.length > 0) { z.find(".duo").each(function (M) { var N = $(this).find(".checked"); if (N.length > 0) { var O = new Array(); N.each(function () { O.push($(this).find("input").val()) }); J.push(O.join()); if (q[M] === O.join()) { H++ } else { s++; if (!m) { $("#" + $(this).attr("id").replace(/t/gm, "n")).addClass("cd"); $(this).append('<div class="item" style="color: red;">答案：' + q[M] + "</div>") } } } else { J.push("") } }) } if (k.length > 0) { z.find(".pan").each(function (N) { var M = $(this).find(".checked input"); if (M.length > 0) { A.push(M.val()); if (p[N] === parseInt(M.val())) { L++ } else { E++; if (!m) { $("#" + $(this).attr("id").replace(/t/gm, "n")).addClass("cd"); var O = p[N] === 1 ? "正确" : "错误"; $(this).append('<div class="item" style="color: red;">答案：' + O + "</div>") } } } else { A.push("") } }) } var y = b.length, I = c.length, u = k.length; var K = G + H + L; var B = w + s + E; var v = K + B; var F = K * 100 / v; var t = 1; switch (true) { case (F < 10): t = 1; break; case (F >= 10 && F < 20): t = 10; break; case (F >= 20 && F < 30): t = 20; break; case (F >= 30 && F < 40): t = 30; break; case (F >= 40 && F < 50): t = 40; break; case (F >= 50 && F < 60): t = 50; break; case (F >= 60 && F < 70): t = 60; break; case (F >= 70 && F < 80): t = 70; break; case (F >= 80 && F < 90): t = 80; break; case (F >= 90): t = 90; break; default: t = 1; break } var D = '<div class="ksdf">'; D += '<div class="layui-progress layui-progress-big" lay-showpercent="t"><div class="layui-progress-bar" lay-percent="' + F.toFixed(2) + '%"></div></div>'; D += '<table class="layui-table"><thead><tr><th rowspan="2" style="width: 20%; background: #fff;text-align:center"><img src="/images/hi/' + t + '.gif" alt="进度图标"/></th><th colspan="4" style="text-align:center">本次考试用时：<span>' + x + "</span></th></tr>"; D += '<tr><th style="width: 20%">单选题/1分</th><th style="width: 20%">多选题/1分</th><th style="width: 20%">判断题/1分</th><th style="width: 20%">合计</th></tr></thead>'; D += "<tbody>"; D += "<tr><td>全部题数</td><td>" + y + "</td><td>" + I + "</td><td>" + u + "</td><td>" + (y + I + u) + "</td></tr>"; D += "<tr><td>答对题数</td><td>" + G + "</td><td>" + H + "</td><td>" + L + "</td><td>" + K + "</td></tr>"; D += "<tr><td>答错题数</td><td>" + w + "</td><td>" + s + "</td><td>" + E + "</td><td>" + B + "</td></tr>"; D += "<tr><td>未答题数</td><td>" + (y - (G + w)) + "</td><td>" + (I - (H + s)) + "</td><td>" + (u - (L + E)) + "</td><td>" + ((y - (G + w)) + (I - (H + s)) + (u - (L + E))) + "</td></tr>"; D += "<tr><td>获得分数</td><td>" + G + "分</td><td>" + H + "分</td><td>" + L + "分</td><td>" + (G + H + L) + "分</td></tr>"; D += "</tbody></table></div>"; r.closeAll(); if (o) { r.open({ type: 1, title: " 考试得分", resize: false, area: "520px", content: D, btn: ["重新考试", "关闭"], success: function () { e.render("progress"); m = true }, yes: function () { r.closeAll(); j(function (M) { n.paper(M.itid) }) }, btn2: function () { r.closeAll() } }) } else { r.open({ type: 1, title: " 考试得分", resize: false, area: "520px", content: D, btn: ["重新考试", "保存记录", "关闭"], success: function () { e.render("progress"); m = true }, yes: function () { r.closeAll(); j(function (M) { n.paper(M.itid) }) }, btn2: function () { r.closeAll(); var M = null, N = (G + H + L); j(function (O) { M = { miid: O.miid, chlist: b.join(), mulist: c.join(), julist: k.join(), chans: C.join(":"), muans: J.join(":"), juans: A.join(":"), score: N, useTime: x } }); if ((G + H + L) <= 0) { r.confirm("一个都没答对，确定保存？", { icon: 5 }, function () { n.save(M) }) } else { n.save(M) } }, btn3: function () { r.closeAll() } }) } }) }, clickBtn: function () { var s = this; $("#marking").off().on("click", function () { if (!m) { if ($("#subCard .yd").length > 0) { r.confirm("确定批阅试题？", { icon: 3 }, function () { s.marking() }) } else { r.msg("没有答题，不能批阅试题", { icon: 2 }) } } else { s.marking() } }) } }, n = { paper: function (s) { $.ajax({ url: "/api/simulatepaper", type: "GET", dataType: "JSON", cache: false, data: { itid: s }, beforeSend: function () { l.param(); r.msg("正在组卷中...", { icon: 16, shade: 0.7 }) }, success: function (v) { if (v !== null) { i.downCount(45, function () { h.marking() }); d(subTpl.innerHTML).render(v, function (w) { $("#subView").html(w) }); var u = 1, t = $("#subCard"); t.empty(); $.each(v.dan, function (w, x) { b.push(x.id); g.push(x.ans); t.append('<dd id="n' + u + '">' + u + "</dd>"); u++ }); $.each(v.duo, function (w, x) { c.push(x.id); q.push(x.ans); t.append('<dd id="n' + u + '">' + u + "</dd>"); u++ }); $.each(v.pan, function (w, x) { k.push(x.id); p.push(x.ans); t.append('<dd id="n' + u + '">' + u + "</dd>"); u++ }); f.icheck(); f.card(); f.noAllKey(); h.clickBtn(); r.closeAll(); $("body,html").animate({ "scrollTop": 0 }, 600) } else { r.closeAll(); r.msg("组卷失败", { icon: 2, end: function () { window.location.replace("/exam/simulate") } }) } }, error: function (t) { alert("ajaxError" + t.responseText) } }) }, save: function (s) { $.ajax({ url: "/api/simulatepaper", type: "POST", dataType: "JSON", cache: false, data: s, beforeSend: function () { r.load(2) }, success: function () { o = true; r.closeAll(); r.msg("保存成功", { icon: 1 }) }, error: function (t) { r.alert(t.responseText) } }) } }; $(function () { j(function (s) { a.fixbar({ top: true }); f.wscroll(); n.paper(s.itid) }) }); function j(s) { s(JSON.parse($("#data").val())) } }) }) });